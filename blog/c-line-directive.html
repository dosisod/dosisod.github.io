<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="" />
  <meta name="og:title" content="How To Add Debug Info To Autogenerated C Code" />
  <link rel="stylesheet" href="/styles/main.css">
  <link rel="stylesheet" href="/styles/github.css" />
  <title>How To Add Debug Info To Autogenerated C Code</title>
</head>
<body>

<main>
<a id="how-to-add-debug-info-to-autogenerated-c-code" href="#how-to-add-debug-info-to-autogenerated-c-code"><h1>How To Add Debug Info To Autogenerated C Code</h1></a>
<br>
<p>I just recently learned about the <code class="hljs">#line</code> directive in C/C++. This is not a very
well known feature (that is, I&#x27;ve never heard about it until now), but is very useful
for people writing compilers that export C code.</p>
<br>
<a id="why-would-you-need-this" href="#why-would-you-need-this"><h2>Why Would You Need This?</h2></a>
<br>
<p>Suppose you have the following programming language:</p>
<br>
<pre class="hljs"><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Hello world!&quot;</span>)</pre>

<br>
<p>You might chose to use C as your compilation target, which means anyone with a
C compiler can compile and run your programming language! Given the above
example, your compiler might output the following C code:</p>
<br>
<pre class="hljs"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>

<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> {
  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Hello world!&quot;</span>);
}</pre>

<br>
<p>All you need to do compile and run it is:</p>
<br>
<pre class="hljs">$ cc file.c -g
$ ./a.out
Hello world!</pre>
<br>
<blockquote>The <code class="hljs">-g</code> flag is what adds the debug info</blockquote>
<br>
<p>Great! But what happens when you try debugging this?</p>
<br>
<pre class="hljs">$ gdb a.out -q
Reading symbols from a.out...
(gdb) b main
Breakpoint 1 at 0x113d: file file.c, line 4.
(gdb) r
Starting program: a.out
[Thread debugging using libthread_db enabled]
Using host libthread_db library &quot;/usr/lib/libthread_db.so.1&quot;.

Breakpoint 1, main () at file.c:4
4         puts(&quot;Hello world!&quot;);
(gdb)</pre>
<br>
<p>The issue is that the debugger is using the line numbers of our C program, not
our original program. This also means that the user will be debugging the generated
C code, which probably isn&#x27;t what we want.</p>
<br>
<a id="the-solution" href="#the-solution"><h2>The Solution</h2></a>
<br>
<p>To fix this, include a <code class="hljs">#line</code> directive for every line that you want to have
different line numbers on:</p>
<br>
<pre class="hljs"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">line</span> 1 <span class="hljs-string">&quot;file.dsl&quot;</span></span>
<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> {
  <span class="hljs-meta">#<span class="hljs-keyword">line</span> 1 <span class="hljs-string">&quot;file.dsl&quot;</span></span>
  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Hello world!&quot;</span>);
}</pre>

<br>
<p>Here <code class="hljs">file.dsl</code> is the source file for our custom DSL (Domain Specific Language).</p>
<br>
<p>Now, when we recompile and debug we get the following:</p>
<br>
<pre class="hljs">$ gdb a.out -q
Reading symbols from a.out...
(gdb) b main
Breakpoint 1 at 0x113d: file file.dsl, line 1.
(gdb) r
Starting program: a.out
[Thread debugging using libthread_db enabled]
Using host libthread_db library &quot;/usr/lib/libthread_db.so.1&quot;.

Breakpoint 1, main () at file.dsl:1
1       print(&quot;Hello world!&quot;)
(gdb)</pre>
<br>
<p>Ta da! Now the debugger shows the correct source line and line number for our code!</p>
<hr>

<script src="https://utteranc.es/client.js"
  repo="dosisod/dosisod.github.io"
  issue-term="title"
  theme="github-light"
  crossorigin="anonymous"
  async>
</script>

<noscript>
  <br>
  <em>
    Comment with GitHub functionality is
    disabled when JavaScript is turned off.
  </em>
</noscript>

</main>

</body>
</html>
