<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="" />
  <meta name="og:title" content="Lost at C: Anonymous Unions" />
  <link rel="stylesheet" href="/styles/main.css">
  <link rel="stylesheet" href="/styles/github.css" />
  <title>Lost at C: Anonymous Unions</title>
</head>
<body>

<main>
<a id="lost-at-c-anonymous-unions" href="#lost-at-c-anonymous-unions"><h1>Lost at C: Anonymous Unions</h1></a>
<br>
<p>This is the first installment of a new series, &quot;Lost at C&quot;, where I go over
obscure language features, historical mishaps, and other interesting parts
about the C programming language.</p>
<br>
<a id="what-are-unions" href="#what-are-unions"><h2>What are unions?</h2></a>
<br>
<p>A union is a data structure that can store many different data types, but
only one at any given time. Let me explain:</p>
<br>
<pre class="hljs"><span class="hljs-class"><span class="hljs-keyword">union</span> <span class="hljs-title">Number</span> {</span>
    <span class="hljs-type">int</span> i;
    <span class="hljs-type">float</span> f;
    <span class="hljs-type">double</span> d;
};</pre>

<br>
<p>Here we define a union called <code class="hljs">Number</code>. It can store an <code class="hljs">int</code>, <code class="hljs">float</code>, and
a <code class="hljs">double</code>. The size of <code class="hljs">Number</code> will be the size of the biggest field in the
union, which will be the <code class="hljs">double</code>.</p>
<br>
<p>To actually use it is pretty simple:</p>
<br>
<pre class="hljs"><span class="hljs-class"><span class="hljs-keyword">union</span> <span class="hljs-title">Number</span> <span class="hljs-title">i</span> =</span> { .i = <span class="hljs-number">1234</span> };
<span class="hljs-class"><span class="hljs-keyword">union</span> <span class="hljs-title">Number</span> <span class="hljs-title">f</span> =</span> { .f = <span class="hljs-number">3.14f</span> };
<span class="hljs-class"><span class="hljs-keyword">union</span> <span class="hljs-title">Number</span> <span class="hljs-title">d</span> =</span> { .d = <span class="hljs-number">1.414</span> };

<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%i\n&quot;</span>, i.i);
<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%f\n&quot;</span>, f.f);
<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%lf\n&quot;</span>, d.d);</pre>

<br>
<p>When compiling, we get the following result:</p>
<br>
<pre class="hljs">1234
3.140000
1.414000</pre>
<br>
<p>Now, what happens if we use a different field then the datatype that we expect?</p>
<br>
<pre class="hljs"><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%i\n&quot;</span>, d.i);
<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%f\n&quot;</span>, i.f);
<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%lf\n&quot;</span>, f.d);</pre>

<br>
<p>Compiling and running:</p>
<br>
<pre class="hljs">1992864825
0.000000
0.000000</pre>
<br>
<p>Was that what you where expecting?</p>
<br>
<p>Basically, to use a union correctly, we need a way of identifying what the
state of the union is in, so that we can use it correctly:</p>
<br>
<pre class="hljs"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">NewNumber</span> {</span>
    <span class="hljs-type">int</span> state;

    <span class="hljs-class"><span class="hljs-keyword">union</span> {</span>
        <span class="hljs-type">int</span> i;
        <span class="hljs-type">float</span> f;
        <span class="hljs-type">double</span> d;
    } num;
};</pre>

<br>
<p>Now instead of using <code class="hljs">Number</code>, we can use <code class="hljs">NewNumber</code>, which will allow
for us to set the <code class="hljs">state</code> field. Now we can set/get the <code class="hljs">state</code> field,
and based on the results, properly handle the data in the <code class="hljs">num</code> union:</p>
<br>
<pre class="hljs"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">NewNumber</span> <span class="hljs-title">age</span> =</span> {
    .state = <span class="hljs-number">0</span>,
    .num = { .i = <span class="hljs-number">1234</span> }
};

<span class="hljs-comment">// call like so:</span>
<span class="hljs-keyword">if</span> (age.state == <span class="hljs-number">0</span>) <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%i\n&quot;</span>, age.num.i);
<span class="hljs-keyword">if</span> (age.state == <span class="hljs-number">1</span>) <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%f\n&quot;</span>, age.num.f);
<span class="hljs-keyword">if</span> (age.state == <span class="hljs-number">2</span>) <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%lf\n&quot;</span>, age.num.d);</pre>

<br>
<p>Here we are using a simple <code class="hljs">int</code> to describe the data being stored in the
union. In practice, we probably want to use an enum to better signify
what state is which.</p>
<br>
<p>Note that the declaration of the union is slightly different as well. There
are many different ways of declaring a union:</p>
<br>
<pre class="hljs"><span class="hljs-comment">// version 1</span>
<span class="hljs-class"><span class="hljs-keyword">union</span> <span class="hljs-title">X</span> {</span> };

<span class="hljs-comment">// version 2</span>
<span class="hljs-class"><span class="hljs-keyword">union</span> <span class="hljs-title">X</span> {</span> } Y;

<span class="hljs-comment">// version 3</span>
<span class="hljs-class"><span class="hljs-keyword">union</span> {</span> } Y;

<span class="hljs-comment">// version 4</span>
<span class="hljs-class"><span class="hljs-keyword">union</span> {</span> };</pre>

<br>
<ol style="margin-left: 3ch">
<li i="1. ">This is what we used originally. This will create a union with a type of <code class="hljs">X</code>, and can be declared via <code class="hljs">union X x = ...</code></li>
<li i="2. ">Same as 1, except we also create an instance of the union, and call it <code class="hljs">Y</code></li>
<li i="3. ">This union is used primarily in structs, since we don&#x27;t need the type, just access to the instance <code class="hljs">Y</code>.</li>
<li i="4. ">This is the anonymous union, which we will explain below!</li>
</ol>
<br>
<br>
<a id="the-anonymous-union" href="#the-anonymous-union"><h2>The anonymous union</h2></a>
<br>
<p>One of the annoying things about our <code class="hljs">NewNumber</code> struct is that we have to
access the number values via this <code class="hljs">.num</code> field, which feels clumsy. If only
there was a way to have the fields inside of the union just become part of
the struct. Well, that is were anonymous unions come in!</p>
<br>
<pre class="hljs"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">FinalNumber</span> {</span>
    <span class="hljs-type">int</span> state;
    <span class="hljs-class"><span class="hljs-keyword">union</span> {</span>
        <span class="hljs-type">int</span> i;
        <span class="hljs-type">float</span> f;
        <span class="hljs-type">double</span> d;
    };
};</pre>

<br>
<p>Now we can use the number like so:</p>
<br>
<pre class="hljs"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">FinalNumber</span> <span class="hljs-title">fn</span> =</span> {
    .state = <span class="hljs-number">0</span>,
    .i = <span class="hljs-number">1234</span>
};

<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%i\n&quot;</span>, fn.i);</pre>

<br>
<a id="what-is-this-good-for" href="#what-is-this-good-for"><h2>What is this good for?</h2></a>
<br>
<p>This is really good for cutting down on the size of structs when they have many
states, but can only be in one at a time. For example, a <code class="hljs">Node</code> struct, which
has a union to pointers containing metadata about different <code class="hljs">Node</code> types:</p>
<br>
<pre class="hljs"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Node</span> {</span>
    <span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">NodeType</span> <span class="hljs-title">type</span>;</span>
    <span class="hljs-class"><span class="hljs-keyword">union</span> {</span>
        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">VariableNode</span> *<span class="hljs-title">var</span>;</span>
        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">DefinitionNode</span> *<span class="hljs-title">def</span>;</span>
        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ExpressionNode</span> *<span class="hljs-title">expr</span>;</span>
    };
};</pre>

<br>
<a id="the-cons" href="#the-cons"><h2>The cons</h2></a>
<br>
<p>One of the big drawbacks of using a union is that you can get into weird issues
if you don&#x27;t properly check the state before using the data in the union. For
example:</p>
<br>
<pre class="hljs"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Person</span> {</span>
    <span class="hljs-class"><span class="hljs-keyword">union</span> {</span>
        <span class="hljs-type">const</span> <span class="hljs-type">char</span> *name;
        <span class="hljs-type">char</span> *dynamic_name;
    };

    <span class="hljs-type">unsigned</span> age;
};</pre>

<br>
<p>The person has a <code class="hljs">name</code>, which is a <code class="hljs">const char *</code>. It cannot be touched. But
you can also access <code class="hljs">name</code> via <code class="hljs">dynamic_name</code>, which is not <code class="hljs">const</code>. This means
that if you try to access a name using <code class="hljs">dynamic_name</code> which was set via <code class="hljs">name</code>,
you will (probably) run into some trouble.</p>
<br>
<p>Note that this still could be useful for being able to declare people with
names that aren&#x27;t heap allocated, and not need to use <code class="hljs">strdup</code>. Still, you
need a way to know whether it was heap allocated or not.</p>
<br>
<a id="final-thoughts" href="#final-thoughts"><h2>Final Thoughts</h2></a>
<br>
<p>All in all, anonymous unions (and unions in general) are a really great
language feature when used properly, but can cause some major headaches if used
incorrectly.</p>
<hr>

<script src="https://utteranc.es/client.js"
  repo="dosisod/dosisod.github.io"
  issue-term="title"
  theme="github-light"
  crossorigin="anonymous"
  async>
</script>

<noscript>
  <br>
  <em>
    Comment with GitHub functionality is
    disabled when JavaScript is turned off.
  </em>
</noscript>

</main>

</body>
</html>
